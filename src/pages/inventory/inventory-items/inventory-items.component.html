<app-inventory-form-dialog
  #formDialog
  (onSubmitSuccess)="handleTransactionSuccess()"
/>
<app-inventory-form-dialog-multiple
  #multipleFormDialog
  (onSubmitSuccess)="handleTransactionSuccess()"
/>
<app-inventory-form-dialog-lote
  (onSubmitSuccess)="handleTransactionSuccess()"
/>

@if (inventoryId === null) {
<div class="inventory-items__empty">
  Selecione um estoque para visualizar os produtos.
</div>
} @else {
<section class="smart-filter">
  <div class="smart-filter__controls">
    <div class="smart-filter__search">
      <i class="pi pi-search smart-filter__search-icon"></i>
      <input
        pInputText
        type="text"
        [value]="filters.term"
        placeholder="Buscar por produto ou código"
        (input)="onSearchChange($any($event.target).value)"
      />
      @if (filters.term) {
      <button
        type="button"
        pButton
        icon="pi pi-times"
        severity="secondary"
        (click)="clearSearch()"
        size="small"
        [rounded]="true"
        class="smart-filter__clear"
      ></button>
      }
    </div>
    <p-select
      class="smart-filter__select"
      [options]="availabilityOptions"
      optionLabel="label"
      optionValue="value"
      [ngModel]="filters.availability"
      (onChange)="onAvailabilityChange($event.value)"
      placeholder="Disponibilidade"
      appendTo="body"
    ></p-select>
    <button
      type="button"
      pButton
      icon="pi pi-filter-slash"
      label="Limpar filtros"
      severity="secondary"
      (click)="clearFilters()"
      [disabled]="!hasFilters"
    ></button>
  </div>
  <div class="smart-filter__chips">
    @if (filters.availability === 'in_stock') {
    <p-chip label="Com estoque" removable (onRemove)="clearAvailability()" />
    } @else if (filters.availability === 'out_of_stock') {
    <p-chip label="Sem estoque" removable (onRemove)="clearAvailability()" />
    }
    @if (filters.term) {
    <p-chip [label]="filters.term" removable (onRemove)="clearSearch()" />
    }
  </div>
</section>

  <div class="inventory-items__actions">
    <div class="inventory-items__buttons">
      <button
        type="button"
        pButton
        icon="pi pi-plus"
        label="Adicionar produtos"
        (click)="openMultipleTransaction()"
        [disabled]="inventoryId === null"
      ></button>
      <p-splitButton
        label="Movimentar em lote"
        icon="pi pi-arrow-right-arrow-left"
        severity="secondary"
        [model]="batchMenuItems"
        [disabled]="selectedProductsCount === 0"
        appendTo="body"
      ></p-splitButton>
    </div>
    <div class="inventory-items__selection">
      <p-checkbox
        inputId="select-all-products"
        [binary]="true"
        [ngModel]="selectAllChecked"
        (onChange)="onSelectAllChange($event)"
        [disabled]="!hasVisibleProducts"
      >
      </p-checkbox>
      <label for="select-all-products">Selecionar todos</label>
    </div>
  </div>

<section class="inventory-products">
  @if (isLoading$ | async) {
  <div class="inventory-products__loading">
    @for (item of [0, 1, 2, 3]; track item) {
    <p-skeleton height="190px" styleClass="product-card product-card--skeleton"></p-skeleton>
    }
  </div>
  } @else {
  @if (paginatedItems$ | async; as paginated) {
  @if (paginated.totalItems > 0) {
  <div class="inventory-products__grid">
    @for (product of paginated.items; track product.sku_code) {
    <article
      class="product-card"
      [class.product-card--selected]="isProductSelected(product.inventory_item_id)"
      (click)="toggleProductSelection(product)"
    >
      <div class="product-card__header" (click)="$event.stopPropagation()">
        <p-checkbox
          [binary]="true"
          [ngModel]="isProductSelected(product.inventory_item_id)"
          (onChange)="onProductSelectionChange(product, $event)"
          inputId="product-{{ product.inventory_item_id }}"
          (click)="$event.stopPropagation()"
        ></p-checkbox>
        <label
          class="product-card__header-label"
          for="product-{{ product.inventory_item_id }}"
          (click)="toggleProductSelection(product); $event.preventDefault(); $event.stopPropagation()"
        >
          Selecionar
        </label>
      </div>
      <div class="product-card__info">
        <h3>{{ product.product_name }}</h3>
        <span class="product-card__code">Código: {{ product.sku_code }}</span>
      </div>
      <div class="product-card__quantity">
        <span>Quantidade atual</span>
        <strong>{{ product.quantity | number: '1.0-0' }} unidades</strong>
      </div>
      <div class="product-card__actions">
        <button
          pButton
          size="small"
          type="button"
          icon="pi pi-arrow-down-left"
          label="Entrada"
          severity="primary"
          (click)="openTransaction(InventoryTypeEnum.IN, product)"
        ></button>
        <button
          pButton
          size="small"
          type="button"
          icon="pi pi-arrow-up-right"
          label="Saída"
          severity="help"
          (click)="openTransaction(InventoryTypeEnum.OUT, product)"
        ></button>
        <button
          pButton
          size="small"
          type="button"
          icon="pi pi-arrow-right-arrow-left"
          label="Transferir"
          severity="secondary"
          (click)="openTransaction(InventoryTypeEnum.TRANSFER, product)"
        ></button>
      </div>
    </article>
    }
  </div>
  <div class="inventory-products__footer">
    @if (paginated.totalItems > paginated.pageSize) {
    <p-paginator
      [rows]="paginated.pageSize"
      [totalRecords]="paginated.totalItems"
      [first]="(paginated.page - 1) * paginated.pageSize"
      (onPageChange)="onPageChange($event)"
    ></p-paginator>
    }
  </div>
  } @else {
  <div class="inventory-products__empty">
    Nenhum produto encontrado com os filtros selecionados.
  </div>
  }
  } @else {
  <div class="inventory-products__loading">
    @for (item of [0, 1, 2, 3]; track item) {
    <p-skeleton height="190px" styleClass="product-card product-card--skeleton"></p-skeleton>
    }
  </div>
  }
  }
</section>
}
